# AI视频生成系统说明文档

## 1. 项目概述

AI视频生成系统是一个基于AI技术的端到端视频创作平台，能够自动从输入视频生成完整的视频作品。系统整合了视频分析、关键帧提取、内容生成、视频合成等全流程功能，实现了AI辅助的自动化视频创作。

## 2. 核心功能

### 2.1 端到端视频处理流程

- **视频切片**：将输入视频分割成多个片段，分离音频和视频
- **视频分析**：使用AI模型分析视频内容和提取关键帧
- **提示词生成与优化**：基于视频分析结果生成和优化场景提示词
- **场景视频生成**：根据提示词生成关键帧和视频片段
- **一致性检查**：确保生成的视频内容与原视频保持一致
- **音频合成**：为生成的视频添加语音解说
- **最终视频合成**：将所有场景视频和音频合成完整视频

### 2.2 技术亮点

- 支持多种AI模型：qwen-omni-turbo、qwen3-vl-plus、qwen-image-edit
- 自动化关键帧传递，保持场景连贯性
- 实时一致性检查和优化
- 灵活的视频切片和合成策略
- 支持多种视频格式和分辨率


## 4. 目录结构

```
backend/
├── app/                     # 主应用目录
│   ├── __init__.py          # 应用初始化
│   ├── agents/              # AI代理实现
│   ├── services/            # 业务服务
│   │   ├── ffmpeg_service.py # FFmpeg视频处理服务
│   │   ├── qwen_vl_service.py # Qwen-VL视频分析服务
│   │   ├── qwen_video_service.py # Qwen视频生成服务
│   │   ├── content_generation_service.py # 内容生成服务
│   │   ├── scene_segmentation_service.py # 场景分割服务
│   │   └── json_prompt_parser.py # JSON提示词解析器
│   ├── routes/              # API路由
│   └── utils/               # 工具类
|   |__ video_consistency_agent #一致性检查agent
├── config.py                # 配置文件
├── run.py                   # 应用入口
└── requirements.txt         # 依赖列表
```

## 5. 安装和依赖

### 5.1 环境准备

1. 安装Python 3.10+
2. 安装FFmpeg并添加到系统路径

### 5.2 安装依赖

```bash
cd backend
pip install -r requirements.txt
```

### 5.3 配置文件

1. 复制`.env.example`为`.env`
2. 配置AI模型API密钥

## 6. 使用说明

### 6.1 启动应用

```bash
cd backend
python run.py
```

应用将在 http://0.0.0.0:5000 启动

### 6.2 运行视频处理流程

使用`test_simple_video_process.py`脚本可以测试完整的视频处理流程（简易流程，仅切4个切片）：

```bash
python test_simple_video_process.py <视频文件路径>   （需要输入本地的视频地址）
```


## 7. 工作流程详细说明

### 7.1 视频处理工作流

1. **初始化**：创建工作流实例，初始化各服务组件
2. **视频切片**：将输入视频分割成多个片段，分离音频和视频
3. **视频分析**：
   - 使用qwen-omni-turbo分析视频内容并生成json格式的prompt
   - 提取关键帧
   - 使用qwen3-vl-plus分析关键帧并生成json格式的prompt
   - 两个模型共同生成prompt然后进行结合
4. **提示词优化**：
   - 使用qwen-plus-latest优化提示词
5. **JSON提示词解析**：解析和验证提示词格式
6. **场景视频生成**：
   - 使用qwen-image-edit生成关键帧
   - 使用wan2.5从关键帧生成视频
   - 进行一致性检查
   - 不满足一致性检查，优化prompt和参数打回重做
7. **音频合成**：为生成的视频添加语音解说
8. **最终视频合成**：将所有场景视频和音频合成完整视频

### 7.2 关键帧传递方式

系统采用关键帧传递机制，确保生成的视频场景之间保持连贯：

1. 从每个视频切片提取关键帧
2. 将当前场景的关键帧传递给下一个场景
3. 在下一个场景生成时，参考上一个场景的关键帧（之后应改为首尾帧）
4. 实时进行一致性检查，确保场景过渡自然

### 8 一致性检查agent

**一致性检查方式**：
1. **感知阶段**：
   - 通过qwen3-vl获取当前场景的多源关键帧信息
   - 获取当前场景的详细信息（如提示词、生成参数等）
   - 获取上一场景的关键帧和相关信息

2. **分析阶段**：
   - 视觉一致性：检查关键帧之间的视觉特征相似度（颜色、构图、物体位置）
   - 语义一致性：检查场景内容的语义连贯性（物体、动作、场景描述）
   - 风格一致性：检查生成风格的统一性（绘画风格）
   - 时序一致性：检查场景间的时间和动作连贯性

3. **决策阶段**：
   - 计算一致性评分（0-1.0）内容40%，场景、人物、视觉等60%
   - 判断是否通过一致性检查，不通过重新生成视频
   - 优化prompt和视频生成参数

4. **循环检查机制**：
   - 目前支持3次重试机制
   - 如果一致性检查失败，根据优化建议重新生成场景
   - 直到通过检查或达到最大重试次数

